# 🚀 启用实时同步功能 - 操作指南

## 📖 简介

本指南将教你如何在Supabase中启用实时同步功能，只需**5分钟**即可完成配置。

配置完成后，你的应用将支持：
- ✅ 多人同时操作自动同步
- ✅ 1秒内看到其他用户的更新
- ✅ 自动显示通知："XXX 刚刚更新了申请记录"

---

## 📋 准备工作

在开始之前，请确保：
- [ ] 你有Supabase账号的登录权限
- [ ] 浏览器已打开（推荐使用Chrome或Firefox）
- [ ] 已准备好`database/enable_realtime.sql`脚本

---

## 🎯 操作步骤（共4步）

### 步骤 1: 登录 Supabase 控制台

1. **打开浏览器**，访问：https://app.supabase.com

2. **登录你的账号**
   - 输入邮箱和密码
   - 或使用GitHub账号登录

3. **选择项目**
   - 在项目列表中找到你的项目
   - 项目名称应该类似："PhD Application Tracker"
   - 项目ID: `cacvfqtupprixlmzrury`

4. **进入项目**
   - 点击项目卡片进入项目详情页

![步骤1示意图]
```
┌─────────────────────────────────────┐
│  Supabase Dashboard                 │
│  ┌───────────────────────────────┐  │
│  │ 📊 PhD Application Tracker   │  │
│  │ cacvfqtupprixlmzrury          │  │
│  │                               │  │
│  │ Status: Active ✓              │  │
│  └───────────────────────────────┘  │
│         ↑ 点击这里进入项目            │
└─────────────────────────────────────┘
```

---

### 步骤 2: 打开 SQL Editor

1. **在左侧菜单栏中**，找到并点击 **"SQL Editor"**
   - 图标是一个 `</>` 符号
   - 位置通常在"Database"下方

2. **点击 "New query"** 按钮
   - 位于右上角
   - 或按快捷键 `Ctrl+N` (Windows) / `Cmd+N` (Mac)

3. **你会看到一个空白的SQL编辑器**
   - 左侧是查询历史
   - 右侧是代码编辑区
   - 下方是结果输出区

![步骤2示意图]
```
┌─────────────────────────────────────────────────────┐
│ Supabase SQL Editor                                 │
├───────────┬─────────────────────────────────────────┤
│           │  [New query +]                          │
│ 📜 History│                                          │
│           │  1 | -- 在这里粘贴SQL代码                │
│  • Query 1│  2 |                                     │
│  • Query 2│  3 |                                     │
│           │  4 |                                     │
│           │  5 |                                     │
│           │                                          │
│           │  [▶ Run] [Format] [Save]                │
│           │                                          │
│           ├─────────────────────────────────────────┤
│           │ Results (执行结果会显示在这里)           │
└───────────┴─────────────────────────────────────────┘
```

---

### 步骤 3: 粘贴并执行脚本

1. **打开脚本文件**
   - 在你的项目目录中找到：`database/enable_realtime.sql`
   - 使用任何文本编辑器打开（VS Code、记事本等）

2. **复制全部内容**
   - 按 `Ctrl+A` 全选
   - 按 `Ctrl+C` 复制
   - **或者直接复制下面的代码块**

3. **粘贴到SQL Editor中**
   - 回到浏览器中的SQL Editor
   - 点击代码编辑区
   - 按 `Ctrl+V` 粘贴

4. **执行脚本**
   - 点击右下角的绿色 **"Run"** 按钮
   - 或按快捷键 `Ctrl+Enter` (Windows) / `Cmd+Enter` (Mac)

5. **等待执行完成**
   - 脚本执行时间约5-10秒
   - 你会看到下方出现执行进度

![步骤3示意图]
```
┌─────────────────────────────────────────────────────┐
│  1 | -- ====================================        │
│  2 | -- 启用 Supabase Realtime 实时同步功能          │
│  3 | -- ====================================        │
│  4 |                                                 │
│  5 | DO $$                                          │
│  6 | BEGIN                                          │
│  7 |     RAISE NOTICE '开始检查...';                 │
│  8 | END $$;                                        │
│  9 |                                                 │
│    |                                                 │
│    |  [▶ Run] ← 点击这里执行                         │
└─────────────────────────────────────────────────────┘
```

---

### 步骤 4: 查看执行结果

**成功的标志**：

在结果区域（Results）中，你应该看到类似以下输出：

```
========================================
开始检查 Realtime 配置...
========================================

当前已启用 Realtime 的表: 无 (尚未启用任何表)

========================================
正在启用 Realtime...
========================================

✅ universities 表已启用 Realtime
✅ professors 表已启用 Realtime
✅ applications 表已启用 Realtime
✅ followup_logs 表已启用 Realtime
✅ email_templates 表已启用 Realtime

========================================
验证配置结果...
========================================

已启用 Realtime 的表列表:
--------------------
  1. public.applications ✓
  2. public.email_templates ✓
  3. public.followup_logs ✓
  4. public.professors ✓
  5. public.universities ✓

总计: 5 个表已启用 Realtime

========================================
核心表启用状态检查:
========================================

✅ 所有核心表都已启用 Realtime!

🎉 配置完成！现在你可以：
  1. 打开两个浏览器窗口访问应用
  2. 在一个窗口中修改数据
  3. 另一个窗口将在1秒内自动更新

========================================
✨ 脚本执行完成!
========================================

| status       | enabled_tables_count | table_names                          |
|--------------|----------------------|--------------------------------------|
| ✅ 配置摘要  | 5                    | applications, email_templates, ...   |
```

**如果看到所有 ✅ 绿色勾号，说明配置成功！**

---

## 🧪 测试实时同步

配置完成后，立即测试功能是否正常：

### 测试方法1：双窗口测试

1. **打开第一个浏览器窗口**
   - 访问你的应用：https://你的域名.vercel.app
   - 按 `F12` 打开开发者工具
   - 切换到 **"Console"** 标签

2. **打开第二个浏览器窗口**
   - 可以用无痕模式（Ctrl+Shift+N）
   - 或者用另一个浏览器
   - 访问同一个应用地址

3. **在第一个窗口中操作**
   - 找到任意一个导师
   - 修改他的状态（例如：从"待发送"改为"已发送"）
   - 点击保存

4. **观察第二个窗口**
   - 应该在 **1秒内** 看到该导师的状态自动更新
   - 右上角会弹出提示："[你的用户名] 刚刚更新了申请记录"

**✅ 如果第二个窗口自动更新了，说明实时同步工作正常！**

### 测试方法2：控制台检查

在浏览器开发者工具的Console中，你应该看到：

```javascript
✅ 实时同步已启用 (applications + professors)

// 当你修改数据时，会看到：
实时更新 (applications): {eventType: 'UPDATE', new: {...}, old: {...}}
```

### 测试方法3：Network检查

1. 按 `F12` 打开开发者工具
2. 切换到 **"Network"** 标签
3. 在筛选栏选择 **"WS"**（WebSocket）
4. 刷新页面
5. 你应该看到一个WebSocket连接
   - URL类似：`wss://cacvfqtupprixlmzrury.supabase.co/realtime/v1/websocket`
   - 状态：`101 Switching Protocols`（绿色）
   - 如果是绿色的，说明连接成功

---

## ❌ 常见问题排查

### 问题1：执行脚本时报错

**错误信息**: `permission denied for publication supabase_realtime`

**原因**: 你的账号没有权限修改Publication

**解决方法**:
1. 确保你登录的是项目所有者账号
2. 或者在Supabase Dashboard → Settings → Team → 邀请你的账号为Admin

---

### 问题2：脚本执行成功，但实时同步不工作

**可能原因**:
1. 浏览器缓存问题
2. WebSocket连接被阻止

**解决方法**:
1. **清除浏览器缓存**
   - 按 `Ctrl+Shift+Delete`
   - 勾选"缓存的图像和文件"
   - 点击"清除数据"

2. **硬刷新页面**
   - 按 `Ctrl+Shift+R` (Windows)
   - 或 `Cmd+Shift+R` (Mac)

3. **检查防火墙/代理**
   - 尝试关闭VPN
   - 或者用手机4G网络测试

4. **检查浏览器扩展**
   - 尝试关闭广告拦截器
   - 或者用无痕模式测试

---

### 问题3：只显示部分表已启用

**错误信息**: `⚠️  professors 表已经启用了 Realtime (跳过)`

**原因**: 表已经启用过了，这不是错误

**解决方法**: 无需处理，这是正常情况

---

### 问题4：看到 "❌ ... 表启用失败"

**可能原因**:
1. 表不存在
2. 数据库连接问题

**解决方法**:
1. **检查表是否存在**
   - 在SQL Editor中运行：
     ```sql
     SELECT tablename FROM pg_tables WHERE schemaname = 'public';
     ```
   - 确保 `professors` 和 `applications` 在列表中

2. **检查项目状态**
   - 访问：Dashboard → Settings → General
   - 确保项目状态为 "Active" (绿色)
   - 如果是 "Paused"，点击 "Restore" 恢复

---

## 📞 需要帮助？

如果按照以上步骤仍然无法解决问题，请提供以下信息：

1. **浏览器控制台的完整日志**
   - 按 `F12` → Console → 右键 → "Save as..."

2. **SQL执行结果的截图**
   - 特别是有 ❌ 或 ⚠️ 的部分

3. **Network标签的WebSocket信息**
   - 按 `F12` → Network → WS → 右键WebSocket连接 → "Copy" → "Copy all as HAR"

4. **项目信息**
   - Supabase项目ID
   - 项目状态（Active / Paused）

---

## 🎉 配置成功后的效果

配置成功后，你的应用将具备以下能力：

### 1. 实时协作
```
用户A (电脑)                     用户B (手机)
    |                                |
    | 标记导师为"已发送"               |
    | ──────────────────────────────> |
    |                                | ← 1秒内看到更新
    |                                | 弹出通知："A 刚刚更新了申请记录"
```

### 2. 新增数据同步
```
用户A                            用户B
    |                                |
    | 添加新导师                       |
    | ──────────────────────────────> |
    |                                | ← 列表自动刷新
    |                                | 新导师卡片出现
```

### 3. 删除数据同步
```
用户A                            用户B
    |                                |
    | 删除导师                         |
    | ──────────────────────────────> |
    |                                | ← 导师卡片消失
    |                                | 列表自动重排
```

---

## ✅ 完成清单

配置完成后，请勾选以下检查项：

- [ ] SQL脚本执行成功，看到所有 ✅
- [ ] 浏览器控制台显示 "✅ 实时同步已启用"
- [ ] Network标签有绿色的WebSocket连接
- [ ] 双窗口测试通过，第二个窗口能看到第一个窗口的操作
- [ ] 收到了"XXX 刚刚更新了申请记录"的通知

**如果所有项都勾选了，恭喜你！实时同步功能已完全配置成功！** 🎉

---

## 📚 补充资料

### Realtime工作原理

```
┌─────────────────────────────────────────────────────────┐
│                  Supabase Realtime 架构                  │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  用户A浏览器                  Supabase服务器              │
│     │                              │                     │
│     │ 1. 修改数据 (UPDATE)          │                     │
│     │ ──────────────────────────> │                     │
│     │                              │                     │
│     │                           [PostgreSQL]             │
│     │                              │                     │
│     │                              ↓                     │
│     │                        生成 WAL 日志               │
│     │                              │                     │
│     │                              ↓                     │
│     │                     [Realtime Server]              │
│     │                        监听 WAL                    │
│     │                              │                     │
│     │                              ↓                     │
│     │                        通过 WebSocket              │
│     │                          广播变更                  │
│     │                              │                     │
│     │                              ↓                     │
│  用户B浏览器 <─────────────────────┘                     │
│     │                                                    │
│     │ 2. 接收更新 (payload)                              │
│     │ 3. 刷新UI                                          │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

### 相关文档链接

- [Supabase Realtime官方文档](https://supabase.com/docs/guides/realtime)
- [PostgreSQL Logical Replication](https://www.postgresql.org/docs/current/logical-replication.html)
- [WebSocket协议规范](https://datatracker.ietf.org/doc/html/rfc6455)

---

**最后更新时间**: 2025-11-05
**维护者**: Claude Code Assistant
**如有问题**: 请查看项目的 `REALTIME_SYNC_DIAGNOSIS.md` 获取更多诊断信息
