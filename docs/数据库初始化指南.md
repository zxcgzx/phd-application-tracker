# 数据库初始化指南

## 🔴 问题症状

- 网页打开后看不到导师信息
- 控制台显示 401 Unauthorized 错误
- 统计面板显示 0 位导师

## 🔍 原因分析

**最可能的原因**: 数据库还没有初始化表结构!

虽然Supabase项目已创建,但需要手动执行SQL脚本来创建所有表。

---

## ✅ 解决方案: 初始化数据库

### 方式1: 使用Supabase Web界面 (推荐)⭐

#### 步骤1: 打开Supabase SQL Editor

1. 访问 Supabase Dashboard: https://app.supabase.com/
2. 选择你的项目 (示例: `abcdefghijklmno`)
3. 左侧菜单点击 **SQL Editor**

#### 步骤2: 执行初始化脚本

1. 点击右上角 **New query** (新建查询)

2. 打开本地文件: `database/init_all.sql`

3. **全选复制** 文件中的所有内容 (Ctrl+A, Ctrl+C)

4. **粘贴** 到Supabase SQL Editor中

5. 点击右下角 **Run** (或按 Ctrl+Enter)

6. 等待执行完成 (约5-10秒)

7. 看到底部显示: ✅ **Success. No rows returned**

#### 步骤3: 验证初始化成功

1. 左侧菜单点击 **Table Editor**

2. 应该能看到以下6个表:
   - ✅ universities (学校表)
   - ✅ professors (导师表)
   - ✅ applications (申请记录表)
   - ✅ followup_logs (跟进记录表)
   - ✅ email_templates (邮件模板表)
   - ✅ crawl_logs (爬虫日志表)

3. 点击 **universities** 表,应该能看到1条记录:
   - 北京理工大学自动化学院

4. 点击 **email_templates** 表,应该能看到4个邮件模板

5. **professors** 表应该是**空的** (还没运行爬虫)

---

### 方式2: 使用Supabase CLI (高级用户)

```bash
# 安装Supabase CLI
npm install -g supabase

# 登录
supabase login

# 链接到项目
supabase link --project-ref 你的项目ID

# 执行SQL
supabase db push
```

---

## 🚀 初始化完成后的下一步

### 1. 运行爬虫 (GitHub Actions)

1. 访问: https://github.com/zxcgzx/phd-application-tracker/actions
2. 点击 "手动触发爬虫"
3. 点击 "Run workflow" → "Run workflow"
4. 等待约3分钟

### 2. 验证数据

#### 在Supabase中验证:

1. Table Editor → **professors** 表
2. 应该能看到 **74位导师**
3. 随机点击一条记录,查看详细信息

#### 在网站上验证:

1. 打开: https://phd-application-tracker-7zg1.vercel.app/
2. **强制刷新**: Ctrl + Shift + R
3. 点击 "导师列表" Tab
4. 应该能看到导师卡片!

---

## 🐛 常见问题排查

### Q1: SQL执行失败,提示"relation already exists"?

**A**: 说明表已经创建过了。解决方案:

**选项1**: 删除所有表重新创建

在SQL Editor中执行:

```sql
-- ⚠️ 警告: 这会删除所有数据!
DROP TABLE IF EXISTS crawl_logs CASCADE;
DROP TABLE IF EXISTS followup_logs CASCADE;
DROP TABLE IF EXISTS email_templates CASCADE;
DROP TABLE IF EXISTS applications CASCADE;
DROP TABLE IF EXISTS professors CASCADE;
DROP TABLE IF EXISTS universities CASCADE;

-- 然后重新运行 init_all.sql
```

**选项2**: 只创建缺失的表

检查Table Editor,看哪些表缺失,只执行对应部分的SQL。

---

### Q2: 表创建成功,但网页仍显示401错误?

**A**: 可能是RLS策略没有正确应用。执行以下SQL:

```sql
-- 确保RLS策略允许匿名访问
DROP POLICY IF EXISTS "允许所有人读取导师" ON professors;
DROP POLICY IF EXISTS "允许所有人写入导师" ON professors;

CREATE POLICY "允许所有人读取导师"
ON professors FOR SELECT
TO anon, authenticated
USING (true);

CREATE POLICY "允许所有人写入导师"
ON professors FOR ALL
TO anon, authenticated
USING (true);

-- 对其他表重复同样操作
```

---

### Q3: 爬虫运行成功,但professors表仍是空的?

**A**: 可能的原因:

1. **GitHub Secrets配置错误**
   - 检查 SUPABASE_URL 和 SUPABASE_SERVICE_KEY 是否正确
   - URL格式: `https://xxxxx.supabase.co` (不要有多余空格)

2. **Service Key权限不足**
   - 确认使用的是 **service_role** key,不是 anon key
   - 在 Supabase → Settings → API 中复制

3. **查看GitHub Actions日志**
   - Actions → 点击运行记录
   - 展开 "🕷️ 执行爬虫" 步骤
   - 查看是否有错误信息

---

### Q4: 如何手动添加导师数据进行测试?

**A**: 在Supabase Table Editor中:

1. 点击 **universities** 表
2. 复制第一行的 **id** (UUID格式)

3. 点击 **professors** 表
4. 点击 "Insert row"
5. 填写:
   ```
   university_id: <刚才复制的UUID>
   name: 测试导师
   email: test@example.com
   title: 教授
   research_areas: {机器学习, 深度学习}
   ```
6. 点击 Save

7. 刷新网页,应该能看到这条记录

---

## 📋 完整检查清单

请按顺序检查:

- [ ] 1. Supabase项目已创建
- [ ] 2. 在SQL Editor中执行了 `init_all.sql`
- [ ] 3. Table Editor中能看到6个表
- [ ] 4. universities表有1条记录
- [ ] 5. email_templates表有4条记录
- [ ] 6. GitHub Secrets已配置 (SUPABASE_URL + SUPABASE_SERVICE_KEY)
- [ ] 7. 手动触发爬虫并等待完成
- [ ] 8. professors表有74条记录
- [ ] 9. 强制刷新网页 (Ctrl+Shift+R)
- [ ] 10. 网页上能看到导师列表

---

## 💡 快速验证脚本

如果已安装Python,可以运行:

```bash
cd /home/boning/申请博士记录
python3 check_database.py
```

如果所有表都返回数据,说明初始化成功!

---

## 📞 仍然无法解决?

请提供以下信息:

1. **Supabase Table Editor截图** - 显示有哪些表
2. **professors表截图** - 显示是否有数据
3. **网页控制台截图** (F12) - 显示错误信息
4. **GitHub Actions运行日志** - 最新一次爬虫运行的完整日志

有了这些信息,可以精确定位问题!

---

**现在就去Supabase执行 init_all.sql 吧! 🚀**
