# 📝 更新日志 - 2025年11月3日

## ♻️ 后续增补（2025-11-04）

### 1. 导师状态更新异常修复
- 现已将申请记录写入流程改为 `upsert`，从源头解决 “duplicate key value violates unique constraint `applications_professor_id_key`” 的报错。
- 批量/快捷状态切换与手动编辑弹窗共享同一条记录，不再出现重复插入冲突。

### 2. 操作人身份改为 `Zhang / Shi`
- 前端筛选器、批量操作与当前用户展示统一使用 `Zhang`、`Shi` 两个选项，更贴合实际使用场景。
- 首次加载会自动把旧数据里的 `你` / `女朋友` 迁移到新标签，同时更新本地缓存，历史记录保持可用。

### 3. 新增数据导入脚本
- 新脚本 `scripts/import_professors.js` 支持直接抓取北航与华电的导师姓名与主页并写入 Supabase。
- 已通过脚本导入北航 93 位、华电 213 位导师，刷新页面即可看到完整名单。

## 🎉 新增功能

### 1. 新增两所学校的爬虫配置

✅ **华北电力大学电气与电子工程学院**
- URL: https://electric.ncepu.edu.cn/szdw/xyjj6/index.htm
- 特点: 支持提取带"Ø"符号标记的研究方向列表
- 配置状态: 已启用 (enabled: true)

✅ **北京航空航天大学自动化科学与电气工程学院**
- URL: https://dept3.buaa.edu.cn/szjs/yjsds/bssds.htm
- 特点: 支持从个人简介中提取研究信息
- 配置状态: 已启用 (enabled: true)

### 2. 大幅增强研究方向提取能力 🚀

#### 问题背景
用户反馈："现在爬取的信息显示太少了，不齐全尤其是研究方向"

#### 解决方案
重写了 `extract_research_areas()` 方法，新增4种提取方式：

**方法1：关键词定位提取**
- 查找"研究方向"、"研究领域"、"Research Interests"等关键词
- 提取关键词后的内容
- 支持多种分隔符：`,` `;` `、` `，` `；` 换行符

**方法2：CSS选择器提取**
- 通过CSS类名直接定位研究方向区域
- 适用于结构化良好的页面

**方法3：列表项批量提取**
- 新增 `selector_all` 配置项
- 可以一次性提取多个元素（如列表中的所有研究方向）
- 示例: `<p>Ø数字信号处理</p> <p>Ø生物电磁学</p>`

**方法4：正则表达式全文搜索**
- 在整个页面文本中搜索"研究方向：xxx"模式
- 适用于非结构化内容

#### 智能清理功能
- 自动去除 `Ø` `·` `•` `-` `*` 等列表符号
- 过滤空项和长度小于2的无效内容
- 支持换行符分割（之前不支持）
- 最多返回10个研究方向，避免信息过载

### 3. 新增信息字段提取

在 `two_level_scraper.py` 中新增：

✅ **学院/部门信息**
- 字段名: `department`
- 关键词: "所在单位", "单位", "学院", "学科"
- 帮助区分不同研究所/学院的导师

✅ **教育背景信息**
- 字段名: `education_background`
- 关键词: "教育背景", "学历", "Education"
- 展示导师的学术经历

### 4. 优化现有配置

#### 北京理工大学（已有配置）
增强提取规则：
- 邮箱优先匹配 `@bit.edu.cn`
- 研究方向使用 `parent_text` 方法提取完整段落
- 新增教育背景提取
- 新增学院信息提取

#### 华北电力大学（新增）
特殊配置：
- 支持"Ø"符号标记的研究方向
- 使用 `selector_all` 批量提取多个段落
- 邮箱优先匹配 `@ncepu.edu.cn`

#### 北京航空航天大学（新增）
特殊配置：
- 从个人简介 `.profile_content` 中提取研究信息
- 支持"博士生导师"等职称识别
- 邮箱优先匹配 `@buaa.edu.cn`

---

## 📊 改进对比

### 之前
```
研究方向: []  ❌ 经常为空
职称: 教授
邮箱: xxx@bit.edu.cn
```

### 现在
```
研究方向: [  ✅ 完整提取
  "数字信号处理技术",
  "生物电磁学",
  "电气装备",
  "人工智能",
  "机器学习"
]
职称: 教授
邮箱: xxx@bit.edu.cn
学院: 自动化学院
教育背景: 2002年重庆大学学士，2008年清华大学博士
办公室: 主楼A713
```

---

## 🧪 测试方法

### 方法1：使用测试脚本（推荐）

```bash
./test_new_schools.sh
```

### 方法2：手动测试

#### 测试华北电力大学
```bash
cd crawler
python main.py --url "https://electric.ncepu.edu.cn/szdw/xyjj6/index.htm" --dry-run
```

#### 测试北京航空航天大学
```bash
python main.py --url "https://dept3.buaa.edu.cn/szjs/yjsds/bssds.htm" --dry-run
```

#### 正式爬取所有学校
```bash
python main.py  # 会爬取所有 enabled: true 的学校
```

### 预期输出示例

```
[1/3] 北京理工大学自动化学院
------------------------------------------------------------
✓ 找到 74 位导师
  [1/74] 爬取: 赵静...

示例导师 1:
  姓名: 赵静
  职称: 教授
  邮箱: zhaojing@bit.edu.cn
  研究方向: 复杂系统控制, 智能优化算法, 机器学习  ✅ 完整提取

[2/3] 华北电力大学电气与电子工程学院
------------------------------------------------------------
✓ 找到 XX 位导师
  ...

[3/3] 北京航空航天大学自动化科学与电气工程学院
------------------------------------------------------------
✓ 找到 XX 位导师
  ...
```

---

## 🔄 部署步骤

### 本地测试（推荐先测试）
```bash
# 1. 测试新配置
./test_new_schools.sh

# 2. 如果测试成功，正式爬取
cd crawler
python main.py
```

### 云端部署（GitHub Actions）
```bash
# 1. 提交代码
git add -A
git commit -m "应用爬虫改进"
git push

# 2. 手动触发爬虫
# 访问: https://github.com/你的用户名/phd-application-tracker/actions
# 点击 "手动触发爬虫" → "Run workflow"
```

---

## 📝 配置文件变更

### crawler/config.yaml
- 新增2所学校配置
- 优化北理工配置
- 所有学校添加 `department` 和 `education_background` 字段

### crawler/scrapers/base_scraper.py
- 重写 `extract_research_areas()` 方法
- 新增4种提取策略
- 智能清理特殊符号

### crawler/scrapers/two_level_scraper.py
- 新增 `department` 提取
- 新增 `education_background` 提取

---

## ⚠️ 注意事项

1. **测试优先**：建议先用 `--dry-run` 测试，确认配置正确后再正式爬取
2. **网络延迟**：如果爬取失败，可能是网络问题，可以增加 `request_delay` 配置
3. **研究方向格式多样**：不同学校的网页格式不同，可能需要微调配置
4. **邮箱加密**：部分学校（如北航）的邮箱可能被加密，无法直接提取

---

## 🐛 已知问题

1. **北航邮箱加密**：北航导师页面的邮箱已加密处理，无法直接获取原始地址
   - 解决方案：尝试从其他来源补充邮箱信息

2. **研究方向在简介中**：部分导师的研究方向混在个人简介文本中，不是结构化字段
   - 解决方案：使用 `parent_text` 方法提取完整段落

---

## 🚀 后续优化方向

1. **自然语言处理**：使用NLP从非结构化文本中提取研究关键词
2. **邮箱去混淆**：支持解密加密的邮箱地址
3. **图片OCR**：提取嵌入在图片中的信息
4. **智能容错**：自动检测提取失败的字段并尝试其他方法

---

**更新时间**: 2025年11月3日
**版本**: v1.1
**改进人**: Claude Code 🤖
