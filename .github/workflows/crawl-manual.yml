name: æ‰‹åŠ¨è§¦å‘çˆ¬è™«

on:
  workflow_dispatch:  # å…è®¸åœ¨GitHubç½‘é¡µä¸Šæ‰‹åŠ¨è§¦å‘
    inputs:
      target_url:
        description: 'ç›®æ ‡å­¦æ ¡URL (å¯é€‰,ç•™ç©ºåˆ™çˆ¬å–æ‰€æœ‰å·²é…ç½®å­¦æ ¡)'
        required: false
        default: ''
        type: string
      dry_run:
        description: 'æµ‹è¯•æ¨¡å¼ (ä¸å†™å…¥æ•°æ®åº“)'
        required: false
        default: false
        type: boolean

jobs:
  crawl:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ æ‹‰å–ä»£ç 
        uses: actions/checkout@v3

      - name: ğŸ å®‰è£… Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          cd crawler
          pip install -r requirements.txt

      - name: ğŸ•·ï¸ æ‰§è¡Œçˆ¬è™«
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          cd crawler

          # æ„å»ºå‘½ä»¤
          CMD="python main.py"

          # å¦‚æœæŒ‡å®šäº†URL,æ·»åŠ å‚æ•°
          if [ -n "${{ inputs.target_url }}" ]; then
            CMD="$CMD --url '${{ inputs.target_url }}'"
          fi

          # å¦‚æœå¼€å¯æµ‹è¯•æ¨¡å¼,æ·»åŠ å‚æ•°
          if [ "${{ inputs.dry_run }}" == "true" ]; then
            CMD="$CMD --dry-run"
          fi

          echo "æ‰§è¡Œå‘½ä»¤: $CMD"
          eval $CMD

      - name: ğŸ“Š è¾“å‡ºç»Ÿè®¡
        if: success()
        run: |
          echo "âœ… çˆ¬è™«æ‰§è¡ŒæˆåŠŸ!"
          echo "è¯·åœ¨ Supabase æ•°æ®åº“ä¸­æŸ¥çœ‹æ–°å¢çš„å¯¼å¸ˆä¿¡æ¯"

      - name: âŒ é”™è¯¯é€šçŸ¥
        if: failure()
        run: |
          echo "çˆ¬è™«æ‰§è¡Œå¤±è´¥ï¼"
          echo "è¯·æŸ¥çœ‹ä¸Šæ–¹æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯"
