<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®æŒä¹…åŒ–è¯Šæ–­å·¥å…·</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module">
        // å¯¼å…¥é…ç½®
        import { supabase } from './js/supabase-config.js';

        // è¯Šæ–­å·¥å…·
        const DiagnosticTool = {
            async runAllTests() {
                console.log('ğŸ” å¼€å§‹è¯Šæ–­æ•°æ®æŒä¹…åŒ–é—®é¢˜...\n');

                await this.test1_checkConnection();
                await this.test2_testRead();
                await this.test3_testWrite();
                await this.test4_testRLS();
                await this.test5_checkRealtimeConfig();

                console.log('\nâœ… è¯Šæ–­å®Œæˆï¼è¯·æŸ¥çœ‹ä¸Šæ–¹çš„ç»“æœ');
            },

            async test1_checkConnection() {
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                console.log('ã€æµ‹è¯•1ã€‘æ£€æŸ¥ Supabase è¿æ¥');
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

                try {
                    const { data, error } = await supabase
                        .from('universities')
                        .select('count')
                        .limit(1);

                    if (error) {
                        console.error('âŒ è¿æ¥å¤±è´¥:', error.message);
                        console.log('ğŸ“‹ å¯èƒ½åŸå› :');
                        console.log('   - Supabase URL æˆ– API Key é…ç½®é”™è¯¯');
                        console.log('   - Supabase é¡¹ç›®è¢«æš‚åœï¼ˆå…è´¹ç‰ˆé™åˆ¶ï¼‰');
                        console.log('   - ç½‘ç»œé—®é¢˜');
                    } else {
                        console.log('âœ… Supabase è¿æ¥æ­£å¸¸');
                    }
                } catch (err) {
                    console.error('âŒ è¿æ¥æµ‹è¯•å¼‚å¸¸:', err.message);
                }
                console.log('');
            },

            async test2_testRead() {
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                console.log('ã€æµ‹è¯•2ã€‘æ£€æŸ¥æ•°æ®è¯»å–æƒé™');
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

                // æµ‹è¯•è¯»å– professors
                try {
                    const { data: professors, error: profError } = await supabase
                        .from('professors')
                        .select('*')
                        .limit(5);

                    if (profError) {
                        console.error('âŒ æ— æ³•è¯»å– professors è¡¨:', profError.message);
                        console.log('ğŸ“‹ è¿™å¾ˆå¯èƒ½æ˜¯ RLS ç­–ç•¥é—®é¢˜ï¼');
                    } else {
                        console.log(`âœ… æˆåŠŸè¯»å– professors è¡¨ï¼Œå…± ${professors.length} æ¡æ•°æ®`);
                        if (professors.length > 0) {
                            console.log('   ç¤ºä¾‹æ•°æ®:', professors[0]);
                        }
                    }
                } catch (err) {
                    console.error('âŒ è¯»å– professors å¼‚å¸¸:', err.message);
                }

                // æµ‹è¯•è¯»å– applications
                try {
                    const { data: applications, error: appError } = await supabase
                        .from('applications')
                        .select('*')
                        .limit(5);

                    if (appError) {
                        console.error('âŒ æ— æ³•è¯»å– applications è¡¨:', appError.message);
                        console.log('ğŸ“‹ è¿™å¾ˆå¯èƒ½æ˜¯ RLS ç­–ç•¥é—®é¢˜ï¼');
                    } else {
                        console.log(`âœ… æˆåŠŸè¯»å– applications è¡¨ï¼Œå…± ${applications.length} æ¡æ•°æ®`);
                        if (applications.length > 0) {
                            console.log('   ç¤ºä¾‹æ•°æ®:', applications[0]);
                        }
                    }
                } catch (err) {
                    console.error('âŒ è¯»å– applications å¼‚å¸¸:', err.message);
                }
                console.log('');
            },

            async test3_testWrite() {
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                console.log('ã€æµ‹è¯•3ã€‘æ£€æŸ¥æ•°æ®å†™å…¥æƒé™');
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

                // åˆ›å»ºä¸€ä¸ªæµ‹è¯•å¤§å­¦
                const testUni = {
                    name: 'æµ‹è¯•å¤§å­¦_' + Date.now(),
                    url: 'https://test.edu.cn/test_' + Date.now(),
                    scraper_type: 'two_level'
                };

                try {
                    console.log('â†’ å°è¯•åˆ›å»ºæµ‹è¯•å¤§å­¦...');
                    const { data: created, error: createError } = await supabase
                        .from('universities')
                        .insert(testUni)
                        .select()
                        .single();

                    if (createError) {
                        console.error('âŒ æ— æ³•å†™å…¥æ•°æ®:', createError.message);
                        console.log('ğŸ“‹ å¯èƒ½åŸå› :');
                        console.log('   - RLS ç­–ç•¥é˜»æ­¢äº†å†™å…¥ï¼ˆæœ€å¸¸è§ï¼‰');
                        console.log('   - å­—æ®µçº¦æŸå†²çª');
                        console.log('   - ä½¿ç”¨çš„æ˜¯ anon key ä½†ç­–ç•¥è¦æ±‚è®¤è¯');
                        return;
                    }

                    console.log('âœ… å†™å…¥æˆåŠŸï¼ID:', created.id);

                    // ç«‹å³è¯»å–éªŒè¯
                    console.log('â†’ éªŒè¯æ˜¯å¦èƒ½è¯»å›åˆšå†™å…¥çš„æ•°æ®...');
                    const { data: readBack, error: readError } = await supabase
                        .from('universities')
                        .select('*')
                        .eq('id', created.id)
                        .single();

                    if (readError || !readBack) {
                        console.error('âŒ å†™å…¥æˆåŠŸä½†æ— æ³•è¯»å›ï¼è¿™å°±æ˜¯ä½ çš„é—®é¢˜æ‰€åœ¨ï¼');
                        console.log('ğŸ“‹ åŸå› : RLS ç­–ç•¥çš„ USING å’Œ WITH CHECK ä¸ä¸€è‡´');
                        console.log('   â†’ è§£å†³æ–¹æ³•: æ‰§è¡Œ fix_rls_policies.sql');
                    } else {
                        console.log('âœ… å¯ä»¥è¯»å›åˆšå†™å…¥çš„æ•°æ®ï¼ŒæŒä¹…åŒ–æ­£å¸¸');

                        // æ¸…ç†æµ‹è¯•æ•°æ®
                        await supabase
                            .from('universities')
                            .delete()
                            .eq('id', created.id);
                        console.log('â†’ å·²æ¸…ç†æµ‹è¯•æ•°æ®');
                    }
                } catch (err) {
                    console.error('âŒ å†™å…¥æµ‹è¯•å¼‚å¸¸:', err.message);
                }
                console.log('');
            },

            async test4_testRLS() {
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                console.log('ã€æµ‹è¯•4ã€‘æ£€æŸ¥ RLS ç­–ç•¥é…ç½®');
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

                try {
                    // ä½¿ç”¨ service_role æŸ¥è¯¢ç­–ç•¥ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰
                    const { data, error } = await supabase
                        .rpc('check_rls_policies');

                    if (error) {
                        console.log('âš ï¸ æ— æ³•æŸ¥è¯¢ RLS ç­–ç•¥ï¼ˆéœ€è¦ service_role keyï¼‰');
                        console.log('   è¯·åœ¨ Supabase Dashboard â†’ SQL Editor ä¸­è¿è¡Œ:');
                        console.log('   check_rls_policies.sql');
                    } else {
                        console.log('âœ… RLS ç­–ç•¥é…ç½®:', data);
                    }
                } catch (err) {
                    console.log('âš ï¸ RLS ç­–ç•¥æ£€æŸ¥è·³è¿‡ï¼ˆéœ€è¦æ•°æ®åº“æƒé™ï¼‰');
                    console.log('   â†’ è¯·åœ¨ Supabase Dashboard ä¸­æ‰‹åŠ¨æ£€æŸ¥');
                }
                console.log('');
            },

            async test5_checkRealtimeConfig() {
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                console.log('ã€æµ‹è¯•5ã€‘æ£€æŸ¥ Realtime é…ç½®');
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

                console.log('â†’ å¦‚æœå¤šç«¯å®æ—¶åŒæ­¥æ­£å¸¸ï¼Œè¯´æ˜ Realtime é…ç½®æ²¡é—®é¢˜');
                console.log('â†’ é—®é¢˜ä¸åœ¨ Realtimeï¼Œè€Œåœ¨æ•°æ®æŒä¹…åŒ–');
                console.log('');
            },

            // é¢å¤–çš„è°ƒè¯•å‡½æ•°
            async debugApplicationUpdate(professorId, newStatus) {
                console.log('ğŸ› è°ƒè¯•ç”³è¯·è®°å½•æ›´æ–°æµç¨‹');
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

                // 1. æŸ¥æ‰¾ç°æœ‰è®°å½•
                const { data: existing, error: findError } = await supabase
                    .from('applications')
                    .select('*')
                    .eq('professor_id', professorId)
                    .maybeSingle();

                console.log('1. æŸ¥æ‰¾ç°æœ‰è®°å½•:', existing ? 'æ‰¾åˆ°' : 'ä¸å­˜åœ¨', existing);

                // 2. å°è¯•æ›´æ–°/åˆ›å»º
                const payload = {
                    professor_id: professorId,
                    status: newStatus,
                    sent_by: 'Zhang',
                    updated_at: new Date().toISOString()
                };

                if (existing) {
                    console.log('2. æ‰§è¡Œ UPDATE æ“ä½œ...');
                    const { data, error } = await supabase
                        .from('applications')
                        .update(payload)
                        .eq('id', existing.id)
                        .select()
                        .single();

                    console.log('   ç»“æœ:', error ? `âŒ ${error.message}` : 'âœ… æˆåŠŸ', data);
                } else {
                    console.log('2. æ‰§è¡Œ INSERT æ“ä½œ...');
                    const { data, error } = await supabase
                        .from('applications')
                        .insert(payload)
                        .select()
                        .single();

                    console.log('   ç»“æœ:', error ? `âŒ ${error.message}` : 'âœ… æˆåŠŸ', data);
                }

                // 3. ç«‹å³è¯»å›éªŒè¯
                console.log('3. éªŒè¯èƒ½å¦ç«‹å³è¯»å›...');
                const { data: readBack, error: readError } = await supabase
                    .from('applications')
                    .select('*')
                    .eq('professor_id', professorId)
                    .single();

                console.log('   ç»“æœ:', readError ? `âŒ ${readError.message}` : 'âœ… å¯ä»¥è¯»å›', readBack);
            }
        };

        // æš´éœ²åˆ°å…¨å±€
        window.DiagnosticTool = DiagnosticTool;

        // é¡µé¢åŠ è½½åè‡ªåŠ¨è¿è¡Œ
        window.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ“Š æ•°æ®æŒä¹…åŒ–è¯Šæ–­å·¥å…·å·²åŠ è½½');
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log('è¿è¡Œä»¥ä¸‹å‘½ä»¤è¿›è¡Œè¯Šæ–­:');
            console.log('');
            console.log('  DiagnosticTool.runAllTests()        // è¿è¡Œå…¨éƒ¨æµ‹è¯•');
            console.log('  DiagnosticTool.test2_testRead()     // åªæµ‹è¯•è¯»å–');
            console.log('  DiagnosticTool.test3_testWrite()    // åªæµ‹è¯•å†™å…¥');
            console.log('');
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log('');

            // è‡ªåŠ¨è¿è¡Œå…¨éƒ¨æµ‹è¯•
            setTimeout(() => {
                DiagnosticTool.runAllTests();
            }, 500);
        });
    </script>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .card {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2563eb;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #6b7280;
            margin-bottom: 30px;
        }
        .step {
            background: #f9fafb;
            padding: 15px;
            border-left: 3px solid #2563eb;
            margin-bottom: 15px;
        }
        .step h3 {
            margin-top: 0;
            color: #1f2937;
        }
        code {
            background: #1f2937;
            color: #10b981;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 13px;
        }
        .warning {
            background: #fef3c7;
            border-left-color: #f59e0b;
            color: #92400e;
        }
    </style>
</head>
<body>
    <div class="card">
        <h1>ğŸ” æ•°æ®æŒä¹…åŒ–è¯Šæ–­å·¥å…·</h1>
        <p class="subtitle">è‡ªåŠ¨æ£€æµ‹"åˆ·æ–°åæ•°æ®ä¸¢å¤±"çš„é—®é¢˜</p>

        <div class="step">
            <h3>ğŸ“‹ ä½¿ç”¨æ–¹æ³•</h3>
            <p>æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆæŒ‰ <code>F12</code>ï¼‰ï¼Œåˆ‡æ¢åˆ° <code>Console</code> æ ‡ç­¾ï¼ŒæŸ¥çœ‹è‡ªåŠ¨è¿è¡Œçš„è¯Šæ–­ç»“æœã€‚</p>
        </div>

        <div class="step warning">
            <h3>âš ï¸ å¸¸è§é—®é¢˜</h3>
            <p><strong>é—®é¢˜1ï¼š</strong> å¦‚æœæ˜¾ç¤º"âŒ å†™å…¥æˆåŠŸä½†æ— æ³•è¯»å›"</p>
            <p><strong>åŸå› ï¼š</strong> RLS ç­–ç•¥çš„ USING å’Œ WITH CHECK æ¡ä»¶ä¸ä¸€è‡´</p>
            <p><strong>è§£å†³ï¼š</strong> åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œ <code>fix_rls_policies.sql</code></p>
            <br>
            <p><strong>é—®é¢˜2ï¼š</strong> å¦‚æœæ˜¾ç¤º"âŒ æ— æ³•å†™å…¥æ•°æ®"</p>
            <p><strong>åŸå› ï¼š</strong> RLS ç­–ç•¥é˜»æ­¢äº†åŒ¿åç”¨æˆ·å†™å…¥</p>
            <p><strong>è§£å†³ï¼š</strong> åŒæ ·æ‰§è¡Œ <code>fix_rls_policies.sql</code></p>
        </div>

        <div class="step">
            <h3>ğŸ¯ ä¸‹ä¸€æ­¥</h3>
            <p>1. æŸ¥çœ‹æ§åˆ¶å°çš„è¯Šæ–­ç»“æœ</p>
            <p>2. æ ¹æ®æç¤ºæ‰§è¡Œä¿®å¤è„šæœ¬</p>
            <p>3. åˆ·æ–°é¡µé¢é‡æ–°æµ‹è¯•</p>
        </div>
    </div>
</body>
</html>
